<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>School Stuffs</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' />
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/turf/v1.3.0/turf.min.js'></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id='map'></div>
  <script>
    L.mapbox.accessToken = 'pk.eyJ1IjoianZyb3Vzc2VhdSIsImEiOiJYYUNlcVRZIn0.lp0867Jn5ynlj72kMwICSA';
    var map = L.mapbox.map('map', 'jvrousseau.l059j5gf')
      .setView([35.505, -97.512], 11);

    var school_layer = L.geoJson(null, {
      // http://leafletjs.com/reference.html#geojson-style
      onEachFeature: function(feature, layer) {
        if (feature.properties.schoolName.toUpperCase().indexOf('ELEMENTARY') > -1) {
          color = '#edf8e9';
        } else if (feature.properties.schoolName.toUpperCase().indexOf('JUNIOR') > -1 && feature.properties.schoolName.toUpperCase().indexOf('MIDDLE') > -1) {
          color = '#bae4b3';
        } else if (feature.properties.schoolName.toUpperCase().indexOf('HIGH') > -1) {
          color = '#74c476';
        } else {
          color = '#238b45';
        }
        feature.properties.style = {
          color: color,
          weight: 3,
          opacity: 0.95,
          fillOpacity: 0.80,
          fillColor: color
        };
        layer.bindPopup(feature.properties.schoolName);
        layer.setStyle(feature.properties.style);
      }
    });

    var district_layer = L.geoJson(null, {
      style: function (feature) {
        var color = '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6);
        return {
          color: color,
          weight: 1,
          opacity: 0.95,
          fillOpacity: 0.75,
          fillColor: color
        }
      },
      onEachFeature: function(feature, layer) {
        layer.bindPopup(feature.properties.schoolDistrictName);
      }
    });

    var topo_district = omnivore.topojson('data_ingest_node/data/schoolDistricts.topojson', null, district_layer);

    var topo_schools = omnivore.topojson('data_ingest_node/data/schools.topojson', null, school_layer);

    L.control.layers({
      'School Polygons': topo_schools.addTo(map),
      'District Polygons': topo_district
    }).addTo(map);
    var nearest_layer = L.layerGroup().addTo(map);
    map.on('mousemove', function (event) {
      var mouse = turf.featurecollection([turf.point([event.latlng.lng, event.latlng.lat])]),
        within;
      if (topo_district._map) {
        within = turf.within(mouse, topo_district.toGeoJSON());
      } else if (topo_schools._map) {
        within = turf.within(mouse, topo_schools.toGeoJSON());
      }
      nearest_layer.clearLayers();
      if(within.features.length > 0){
        console.log("WITHIN POLYGON");
        L.geoJson(within, {
          style: function (feature) {
            var color = "#FF00FF";
            return {
              color: color,
              weight: 1,
              opacity: 1,
              fillOpacity: 1,
              fillColor: color};
          }
        }).addTo(nearest_layer);
      }
    })
  </script>
</body>

</html>
